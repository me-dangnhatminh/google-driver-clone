# Traefik dynamic configuration file
# See https://doc.traefik.io/traefik/getting-started/configuration-overview/#the-dynamic-configuration

tls:
  certificates:
    - certFile: /etc/config/certs/cert.pem # time to live 25/8/2024 + 15 years
      keyFile: /etc/config/certs/key.pem

tcp:

http:
  middlewares:
    auth:
      basicAuth:
        usersFile: /etc/config/pass/users.htpasswd

    api-stripPrefix:
      stripPrefix:
        prefixes:
          - /api

  routers:
    wordpress:
      rule: Host(`wordpress.{{env "BASE_DOMAIN"}}`)
      service: wordpress
      entrypoints: https
      tls: {}

    dashboard:
      rule: Host(`traefik.{{env "BASE_DOMAIN"}}`)
      service: api@internal
      entrypoints: https
      middlewares:
        - auth
      tls: {}

    identity-api:
      rule: Host(`identity.{{env "BASE_DOMAIN"}}`) && PathPrefix(`/api`)
      service: identity-api
      entrypoints: https
      tls: {}

    identity-grpc:
      rule: Host(`identity-grpc.{{env "BASE_DOMAIN"}}`)
      service: identity-grpc
      entrypoints: https
      tls: {}

  services:
    identity-api:
      loadBalancer:
        servers:
          - url: http://172.17.0.1:3000
    identity-grpc:
      loadBalancer:
        servers:
          - url: h2c://172.17.0.1:50051
    wordpress:
      loadBalancer:
        servers:
          - url: http://172.17.0.1:8000
