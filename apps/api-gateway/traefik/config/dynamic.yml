# Traefik dynamic configuration file
# See https://doc.traefik.io/traefik/getting-started/configuration-overview/#the-dynamic-configuration

tcp:
  routers:
    postgres:
      rule: HostSNI(`postgres.{{env "BASE_DOMAIN"}}`)
      entryPoints: postgres
      service: postgres
      tls:
        passthrough: true

    redis:
      rule: HostSNI(`*`)
      entryPoints: redis
      service: redis

  services:
    postgres:
      loadBalancer:
        servers:
          - address: my-postgres:5432

    redis:
      loadBalancer:
        servers:
          - address: my-redis:6379
http:
  middlewares:
    auth:
      basicAuth:
        usersFile: /etc/config/pass/users.htpasswd

    api-stripPrefix:
      stripPrefix:
        prefixes: ["/identity", "/storage"]

  routers:
    dashboard:
      rule: Host(`abc.{{env "BASE_DOMAIN"}}`)
      service: api@internal
      entrypoints: https
      middlewares:
        - auth
      tls: {}

    portainer:
      rule: Host(`portainer.{{env "BASE_DOMAIN"}}`)
      service: portainer
      entrypoints: https
      tls: {}

    identity:
      rule: Host(`api.{{env "BASE_DOMAIN"}}`) && PathPrefix(`/identity`)
      service: identity
      entrypoints: https
      middlewares:
        - api-stripPrefix
      tls: {}

    payment:
      rule: Host(`api.{{env "BASE_DOMAIN"}}`) && PathPrefix(`/payment`)
      service: payment
      entrypoints: https
      tls: {}

  services:
    portainer:
      loadBalancer:
        servers:
          - url: http://portainer:9000

    identity:
      loadBalancer:
        servers:
          - url: http://localhost:3000

    payment:
      loadBalancer:
        servers:
          - url: http://localhost:4000
